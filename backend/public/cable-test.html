<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Cable Ping Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { --fg:#111; --muted:#6b7280; --ok:#16a34a; --bad:#dc2626; --card:#f9fafb; }
      * { box-sizing: border-box; }
      body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", Arial, "Apple Color Emoji", "Segoe UI Emoji"; color: var(--fg); background: #fff; }
      main { max-width: 720px; margin: 24px auto; padding: 16px; }
      h1 { font-size: 20px; margin: 0 0 8px; }
      .card { background: var(--card); border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-top: 12px; }
      .row { display: flex; align-items: center; gap: 8px; }
      .dot { width: 10px; height: 10px; border-radius: 999px; background: var(--bad); display: inline-block; }
      .muted { color: var(--muted); font-size: 12px; }
      pre { margin: 0; white-space: pre-wrap; word-break: break-word; font-size: 12px; }
      code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      button { padding: 6px 10px; border-radius: 8px; border: 1px solid #e5e7eb; background: white; cursor: pointer; }
      button:active { transform: translateY(1px); }
      .ok { background: #ecfdf5; border-color: #a7f3d0; }
    </style>
  </head>
  <body>
    <main>
      <h1>Action Cable Ping Test</h1>
      <div class="card">
        <div class="row">
          <span id="dot" class="dot" aria-hidden="true"></span>
          <strong id="status">disconnected</strong>
        </div>
        <div class="muted" style="margin-top:6px">
          WebSocket: <code id="ws-url">ws://localhost:3000/cable</code>
        </div>

        <div class="row" style="margin-top:12px; gap:6px;">
          <button id="reconnect">Reconnect</button>
          <button id="unsubscribe">Unsubscribe</button>
          <button id="clear" class="ok">Clear Log</button>
        </div>
      </div>

      <div class="card">
        <strong>Last message</strong>
        <pre id="last">—</pre>
      </div>

      <div class="card">
        <strong>Log</strong>
        <pre id="log"></pre>
        <div class="muted" style="margin-top:6px">
          ※ サーバ側で
          <code>ActionCable.server.broadcast("ping", { message: "pong", at: Time.now.to_s })</code>
          を実行してください。
        </div>
      </div>
    </main>

    <!--
      重要:
      - 同一オリジンで配信すると簡単です: http://localhost:3000/cable-test.html
      - ルーティング: mount ActionCable.server => "/cable"
      - Channel: PingChannel / stream_from "ping"
    -->
    <script type="module">
      import * as ActionCable from "https://cdn.jsdelivr.net/npm/@rails/actioncable/+esm";

      const wsPath = "/cable"; // 同一オリジン
      const wsUrlEl = document.getElementById("ws-url");
      const statusEl = document.getElementById("status");
      const dotEl = document.getElementById("dot");
      const logEl = document.getElementById("log");
      const lastEl = document.getElementById("last");
      const btnReconnect = document.getElementById("reconnect");
      const btnUnsub = document.getElementById("unsubscribe");
      const btnClear = document.getElementById("clear");

      wsUrlEl.textContent = `${location.protocol === "https:" ? "wss" : "ws"}://${location.host}${wsPath}`;

      let cable = null;
      let sub = null;

      function setConnected(connected) {
        statusEl.textContent = connected ? "connected" : "disconnected";
        dotEl.style.background = connected ? "var(--ok)" : "var(--bad)";
      }

      function log(...args) {
        const line = args.map(v => (typeof v === "string" ? v : JSON.stringify(v))).join(" ");
        logEl.textContent += `${new Date().toLocaleTimeString()}  ${line}\n`;
        logEl.scrollTop = logEl.scrollHeight;
      }

      function connect() {
        // 既存を切断
        if (cable) { try { cable.disconnect(); } catch(_){} }
        cable = ActionCable.createConsumer(wsPath);

        sub = cable.subscriptions.create("PingChannel", {
          connected() {
            setConnected(true);
            log("[connected]");
          },
          disconnected() {
            setConnected(false);
            log("[disconnected]");
          },
          received(data) {
            log("received:", data);
            lastEl.textContent = JSON.stringify(data, null, 2);
          }
        });

        // デバッグ用
        window.cable = cable;
        window.sub = sub;
      }

      btnReconnect.addEventListener("click", () => {
        log("[manual] reconnect");
        connect();
      });

      btnUnsub.addEventListener("click", () => {
        if (sub) {
          sub.unsubscribe();
          log("[manual] unsubscribe");
        }
      });

      btnClear.addEventListener("click", () => {
        logEl.textContent = "";
        lastEl.textContent = "—";
      });

      // 初回接続
      connect();
    </script>
  </body>
</html>
